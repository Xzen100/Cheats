--// GODLOCK v20 (FIXED + WORKING, NO FEATURES REMOVED)

--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

--// SETTINGS
local Settings = {
    Aimbot = false,
    FullAuto = false,
    NoRecoil = false,
    WallCheck = false,
    ESP = false,
    FOV = 200,
    Range = 500,
    ESPRange = math.huge,
    LockPart = "Head",
    TeamCheckAimbot = true,
    ESPTeamCheck = true,
    AimYOffset = 0,
}

--// STATE
local targetPart = nil
local currentTool = nil
local fireRemotes = {}
local noRecoilConn = nil
local fullAutoConn = nil
local isHolding = false

--// UTILITIES
local function getLockPart(char)
    return char:FindFirstChild(Settings.LockPart)
        or char:FindFirstChild("Head")
        or char:FindFirstChild("UpperTorso")
        or char:FindFirstChild("HumanoidRootPart")
end

local function isEnemyAimbot(plr)
    if not Settings.TeamCheckAimbot then return true end
    if not LocalPlayer.Team or not plr.Team then return true end
    return LocalPlayer.Team ~= plr.Team
end

local function isEnemyESP(plr)
    if not Settings.ESPTeamCheck then return true end
    if not LocalPlayer.Team or not plr.Team then return true end
    return LocalPlayer.Team ~= plr.Team
end

--// FIXED VISIBILITY CHECK (MODERN RAYCAST)
local function isVisible(part)
    local origin = Camera.CFrame.Position
    local direction = part.Position - origin

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {LocalPlayer.Character}
    params.IgnoreWater = true

    local result = Workspace:Raycast(origin, direction, params)
    return result and result.Instance:IsDescendantOf(part.Parent)
end

--// TARGET SELECTION
local function getTarget()
    local closest = nil
    local shortest = math.huge
    local center = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            local hum = plr.Character:FindFirstChild("Humanoid")
            if hum and hum.Health > 0 and isEnemyAimbot(plr) then
                local part = getLockPart(plr.Character)
                if part and (not Settings.WallCheck or isVisible(part)) then
                    local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                    if onScreen then
                        local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                        if dist < shortest and dist <= Settings.FOV then
                            shortest = dist
                            closest = part
                        end
                    end
                end
            end
        end
    end

    return closest
end

--// TOOL & REMOTES
local function updateTool()
    if LocalPlayer.Character then
        currentTool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
    end
end

local function scanRemotes()
    table.clear(fireRemotes)
    local keywords = {"fire", "shoot", "bullet", "damage", "hit", "gun"}

    local function scan(obj)
        for _, v in ipairs(obj:GetDescendants()) do
            if v:IsA("RemoteEvent") then
                for _, k in ipairs(keywords) do
                    if v.Name:lower():find(k) then
                        table.insert(fireRemotes, v)
                        break
                    end
                end
            end
        end
    end

    scan(ReplicatedStorage)
    if LocalPlayer.Character then scan(LocalPlayer.Character) end
    if LocalPlayer.PlayerGui then scan(LocalPlayer.PlayerGui) end
end

--// NO RECOIL (ACTUALLY WORKS)
local function toggleRecoil(on)
    if on and not noRecoilConn then
        noRecoilConn = RunService.RenderStepped:Connect(function()
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, Camera.CFrame.Position + Camera.CFrame.LookVector)
        end)
    elseif not on and noRecoilConn then
        noRecoilConn:Disconnect()
        noRecoilConn = nil
    end
end

--// ESP
local ESP = {}

local function makeESP(plr)
    if ESP[plr] then return end

    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Color = Color3.fromRGB(255, 0, 0)
    box.Visible = false

    local line = Drawing.new("Line")
    line.Thickness = 1
    line.Color = Color3.fromRGB(255, 0, 0)
    line.Visible = false

    ESP[plr] = {box = box, line = line}
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= LocalPlayer then makeESP(p) end
end

Players.PlayerAdded:Connect(makeESP)
Players.PlayerRemoving:Connect(function(p)
    if ESP[p] then
        ESP[p].box:Remove()
        ESP[p].line:Remove()
        ESP[p] = nil
    end
end)

--// FOV CIRCLE
local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 2
fovCircle.Color = Color3.fromRGB(200, 20, 20)
fovCircle.Filled = false
fovCircle.Visible = false

--// MAIN LOOP
RunService.RenderStepped:Connect(function()
    updateTool()
    targetPart = getTarget()

    -- AIMBOT
    if Settings.Aimbot and targetPart then
        local aimPos = targetPart.Position + Vector3.new(0, Settings.AimYOffset, 0)
        Camera.CFrame = Camera.CFrame:Lerp(
            CFrame.lookAt(Camera.CFrame.Position, aimPos),
            0.9
        )
    end

    -- FOV VISUAL
    fovCircle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    fovCircle.Radius = Settings.FOV
    fovCircle.Visible = Settings.Aimbot

    -- ESP
    if Settings.ESP then
        for plr, esp in pairs(ESP) do
            if plr.Character and isEnemyESP(plr) then
                local root = getLockPart(plr.Character)
                local hum = plr.Character:FindFirstChild("Humanoid")

                if root and hum and hum.Health > 0 then
                    local pos, on = Camera:WorldToViewportPoint(root.Position)
                    if on then
                        local head = plr.Character:FindFirstChild("Head")
                        local headPos = head and Camera:WorldToViewportPoint(head.Position) or pos

                        local h = math.abs(headPos.Y - pos.Y)
                        local w = h / 2

                        esp.box.Size = Vector2.new(w, h)
                        esp.box.Position = Vector2.new(pos.X - w / 2, math.min(pos.Y, headPos.Y))
                        esp.box.Visible = true

                        esp.line.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                        esp.line.To = Vector2.new(pos.X, pos.Y)
                        esp.line.Visible = true
                    else
                        esp.box.Visible = false
                        esp.line.Visible = false
                    end
                else
                    esp.box.Visible = false
                    esp.line.Visible = false
                end
            else
                esp.box.Visible = false
                esp.line.Visible = false
            end
        end
    else
        for _, esp in pairs(ESP) do
            esp.box.Visible = false
            esp.line.Visible = false
        end
    end

    -- FULLAUTO SAFETY
    if not Settings.FullAuto and fullAutoConn then
        fullAutoConn:Disconnect()
        fullAutoConn = nil
        isHolding = false
    end
end)

--// FULL AUTO
UserInputService.InputBegan:Connect(function(input)
    if Settings.FullAuto and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        isHolding = true

        if fullAutoConn then fullAutoConn:Disconnect() end
        fullAutoConn = RunService.Heartbeat:Connect(function()
            if isHolding and targetPart then
                if currentTool then currentTool:Activate() end
                for _, r in ipairs(fireRemotes) do
                    pcall(function()
                        r:FireServer(targetPart.Position, targetPart)
                    end)
                end
            end
        end)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isHolding = false
    end
end)

--// INIT
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    updateTool()
    scanRemotes()
end)

updateTool()
scanRemotes()

print("GODLOCK v20 LOADED - ALL FEATURES WORKING")
